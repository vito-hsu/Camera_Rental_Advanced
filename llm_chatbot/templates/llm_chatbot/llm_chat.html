{% extends 'base.html' %} {# 繼承您的基礎模板，保持網站一致性 #}

{% block title %}LLM 助理{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1>AI 相機租賃助理</h1>
    <div id="chat-container" style="height: 400px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px;">
        <div class="message received">你好！我是您的相機租賃AI助理，有什麼可以幫助您的嗎？</div>
    </div>
    <form id="chat-form" class="mt-3">
        {% csrf_token %} {# Django CSRF token for security #}
        <div class="input-group">
            <input type="text" id="user-input" class="form-control" placeholder="輸入您的問題..." autocomplete="off">
            <button type="submit" class="btn btn-primary">發送</button>
        </div>
    </form>
</div>

<script>
    // 這裡將放置 JavaScript 代碼，用於處理用戶輸入、發送請求到後端、以及顯示 LLM 的回復
    document.addEventListener('DOMContentLoaded', function() {
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const chatContainer = document.getElementById('chat-container');

        chatForm.addEventListener('submit', function(e) {
            e.preventDefault(); // 阻止表單預設提交行為

            const userMessage = userInput.value.trim();
            if (userMessage === '') return;

            // 顯示用戶訊息
            const userDiv = document.createElement('div');
            userDiv.className = 'message sent';
            userDiv.textContent = `您: ${userMessage}`;
            chatContainer.appendChild(userDiv);

            // 清空輸入框
            userInput.value = '';
            chatContainer.scrollTop = chatContainer.scrollHeight; // 滾動到底部

            // 發送請求到後端 (這裡需要 Django 視圖來處理 LLM 呼叫)
            fetch('/llm/api/llm-query/', { // 假設有一個 API endpoint
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ message: userMessage })
            })
            .then(response => response.json())
            .then(data => {
                const llmResponse = data.response; // 假設後端返回的 JSON 中有 'response' 鍵

                // 顯示 LLM 回覆
                const llmDiv = document.createElement('div');
                llmDiv.className = 'message received';
                llmDiv.textContent = `AI助理: ${llmResponse}`;
                chatContainer.appendChild(llmDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight; // 滾動到底部
            })
            .catch(error => {
                console.error('Error:', error);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'message error';
                errorDiv.textContent = 'AI助理: 抱歉，服務暫時不可用。';
                chatContainer.appendChild(errorDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
        });
    });
</script>

<style>
    /* 簡單的聊天樣式，您可以添加到您的 static/css/global.css 或其他地方 */
    #chat-container {
        background-color: #f8f9fa;
        border-radius: 5px;
        margin-bottom: 15px;
    }
    .message {
        padding: 8px 12px;
        margin-bottom: 5px;
        border-radius: 15px;
        max-width: 80%;
    }
    .message.sent {
        background-color: #d1e7dd; /* 綠色背景 */
        align-self: flex-end;
        margin-left: auto;
        text-align: right;
    }
    .message.received {
        background-color: #e2e3e5; /* 灰色背景 */
        align-self: flex-start;
        text-align: left;
    }
    .message.error {
        background-color: #f8d7da; /* 紅色背景 */
        color: #721c24;
    }
    #chat-container {
        display: flex;
        flex-direction: column;
    }
</style>
{% endblock %}